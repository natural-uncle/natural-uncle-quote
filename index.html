<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è‡ªç„¶å¤§å” ç·šä¸Šå ±åƒ¹å–® - æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- UI å¥—ä»¶ï¼šBootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background:#eaeaea; }
    .container-quote {
      max-width: 800px; margin: 10px auto; background:#f9fcff;
      padding: 20px; border:1px solid #ddd; box-shadow:0 0 10px rgba(0,0,0,.1);
      position: relative; overflow: hidden;
    }
    /* âœ… èƒŒæ™¯æµ®æ°´å°ï¼šä½¿ç”¨ 2.pngï¼Œ800px é–“è·ã€-45åº¦ã€é€æ˜ 0.02 */
    .container-quote::before{
      content:""; position:absolute; inset:0;
      background-image:url('https://res.cloudinary.com/dijzndzw2/image/upload/v1756944900/2_oufdld.png');
      background-repeat:repeat; background-size:800px;
      transform:rotate(-45deg); opacity:.02; z-index:0;
    }
    .container-quote > * { position:relative; z-index:1; }

    /* LOGO æ»¿ç‰ˆç½®ä¸­ */
    .logo { width:100%; max-height:150px; object-fit:contain; display:block; margin:0 auto 10px; }

    /* é ‚éƒ¨å›ºå®šè³‡è¨Šï¼ˆæ‰¿è¾¦é …ç›® / å ±åƒ¹æ—¥æœŸï¼‰ */
    .quote-info { text-align:center; font-weight:700; color:#333; margin-bottom:14px; }

    .section-title { margin-top:15px; font-weight:700; border-bottom:2px solid #444; padding-bottom:4px; }

    /* é ç´„æ™‚é–“è—è‰²å¼·èª¿å€ */
    #cleanFullBox{
      font-size:1.4rem; font-weight:700; color:#fff; background:#0d6efd;
      border:2px solid #0a58ca; border-radius:8px; text-align:center; margin-top:10px;
    }

    /* å–®åƒ¹æ—çš„å„ªæƒ å°å­—æç¤º */
    .discount-note{ font-size:.75rem; color:green; display:block; }

    /* ç”¢ç”Ÿé€£çµé¡¯ç¤ºå€ */
    .link-box{ background:#eef6ff; border-radius:6px; padding:10px; margin-top:12px; word-wrap:break-word; }

    .footer-bar{ background:#dbe9f6; padding:12px; text-align:center; margin-top:20px; border-top:2px solid #bbb; }

    @media (max-width:768px){
      .btn{ width:100%; margin-bottom:8px; }
      table{ font-size:.9rem; }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       C. æ‰‹æ©Ÿå¡ç‰‡è¡¨å–®æ¨£å¼ï¼ˆå–ä»£å‚³çµ±è¡¨æ ¼ï¼‰
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 576px){
      #quoteTable thead { display: none; }
      #quoteTable, #quoteTable tbody, #quoteTable tr, #quoteTable td {
        display: block; width: 100%;
      }
      #quoteTable tbody tr{
        background:#fff; border:1px solid #ddd; border-radius:12px;
        padding:10px; margin:10px 0; box-shadow:0 2px 8px rgba(0,0,0,.05);

        /* å¡ç‰‡ç”¨ grid æ’ç‰ˆï¼šä¸Šï¼šæœå‹™/è£œå……ï¼›ä¸‹ï¼šæ•¸é‡/å–®åƒ¹ï¼›æœ€ä¸‹ï¼šå°è¨ˆ/æ“ä½œ */
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "svc svc"
          "opt opt"
          "qty price"
          "sub ops";
        gap: 8px 12px;
      }
      /* æŒ‡å®šå„æ¬„ä½åœ¨ grid çš„å€å¡Š */
      #quoteTable td:nth-child(1){ grid-area: svc; }
      #quoteTable td:nth-child(2){ grid-area: opt; }
      #quoteTable td:nth-child(3){ grid-area: qty; }
      #quoteTable td:nth-child(4){ grid-area: price; }
      #quoteTable td:nth-child(5){ grid-area: sub; }
      #quoteTable td:nth-child(6){ grid-area: ops; }

      #quoteTable td{
        border:0 !important; padding:0;
      }
      #quoteTable td::before{
        content: attr(data-label);
        display:block; font-weight:700; color:#555; margin-bottom:4px;
      }
      /* å°è¨ˆåŠ å¼·é¡¯ç¤º */
      #quoteTable td:nth-child(5) .subtotal{
        display:inline-block; font-size:1.1rem; font-weight:800; color:#d63384;
        padding:4px 8px; background:#fff0f6; border:1px solid #f3c2db; border-radius:8px;
      }
      /* æ“ä½œæŒ‰éˆ•æ»¿ç‰ˆ */
      #quoteTable td:nth-child(6) .btn{ width:100%; }
      /* é¿å…å›ºå®šåº•æ¬„é®ä½å…§å®¹ */
      body{ padding-bottom: 80px; }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       B. æ‰‹æ©Ÿåº•éƒ¨å›ºå®šå·¥å…·åˆ—
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mobile-bottom-bar{
      position: fixed; left:0; right:0; bottom:0; z-index: 1030;
      background: rgba(255,255,255,.96);
      backdrop-filter: saturate(180%) blur(8px);
      border-top:1px solid #ddd; padding:10px 12px;
      display:none; align-items:center; justify-content:space-between;
      gap: 10px;
    }
    @media (max-width: 768px){
      .mobile-bottom-bar{ display:flex; }
    }
    .mobile-bottom-bar .total-strong{
      font-weight: 900; font-size: 1.1rem;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       åˆè¨ˆé†’ç›®æ¨£å¼ï¼ˆæ¡Œæ©Ÿï¼‹æ‰‹æ©Ÿå…±ç”¨ï¼‰
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .total-banner{
      background: #fff7e6; border:1px solid #ffd8a8; color:#d9480f;
      border-radius:12px; padding:10px 14px; display:inline-block; font-weight:900;
      box-shadow: 0 2px 8px rgba(255,173,77,.15);
    }
    .total-banner #total{ font-size:1.4rem; }
  </style>
</head>
<body>
<div class="container-quote">

  <!-- ğŸ”¹ LOGOï¼ˆä½¿ç”¨ 2.pngï¼‰ -->
  <div class="text-center">
    <img src="https://res.cloudinary.com/dijzndzw2/image/upload/v1756944900/2_oufdld.png" alt="è‡ªç„¶å¤§å” Logo" class="logo" />
  </div>

  <!-- ğŸ”¹ æ‰¿è¾¦é …ç›® / å ±åƒ¹æ—¥æœŸï¼ˆè‡ªå‹•å¸¶å…¥ï¼Œéè¼¸å…¥æ¬„ä½ï¼‰ -->
  <div id="quoteInfo" class="quote-info"></div>

  <!-- ğŸ”¹ å®¢æˆ¶è³‡è¨Š -->
  <h5 class="section-title">å®¢æˆ¶è³‡è¨Š</h5>
  <div class="row g-2 mb-3">
    <div class="col-md-6 col-12">
      <label>å§“å</label>
      <input id="customerName" type="text" class="form-control" placeholder="å®¢æˆ¶å§“å" />
    </div>
    <div class="col-md-6 col-12">
      <label>é›»è©±</label>
      <input id="customerPhone" type="text" class="form-control" />
    </div>
  </div>
  <div class="row g-2 mb-3">
    <div class="col-12">
      <label>åœ°å€</label>
      <input id="customerAddress" type="text" class="form-control" placeholder="æœå‹™åœ°å€" />
    </div>
  </div>

  <!-- ğŸ”¹ æŠ€å¸«è³‡è¨Š -->
  <h5 class="section-title">æŠ€å¸«äººå“¡è³‡è¨Š</h5>
  <div class="row g-2 mb-3">
    <div class="col-md-6 col-12">
      <label>æŠ€å¸«å§“å</label>
      <input id="technicianName" type="text" class="form-control" value="æ—å®¥é¨°" />
    </div>
    <div class="col-md-6 col-12">
      <label>æŠ€å¸«è¯çµ¡é›»è©±</label>
      <input id="technicianPhone" type="text" class="form-control" value="0912-356331" />
    </div>
  </div>

  <!-- ğŸ”¹ é ç´„æ¸…æ´—æ™‚é–“ï¼ˆè—åº•å€å¡Šï¼‹æ—¥æœŸ/æ™‚é–“é¸æ“‡ï¼‰ -->
  <h5 class="section-title">é ç´„æ¸…æ´—æ™‚é–“</h5>
  <div id="cleanFullBox" class="p-3">
    ğŸ•’ å®Œæ•´é ç´„æ™‚é–“ï¼š<span id="cleanFull">å°šæœªé¸æ“‡</span>
    <div class="row g-2 mt-2">
      <div class="col-6"><input id="cleanDate" type="date" class="form-control" /></div>
      <div class="col-6"><input id="cleanTime" type="time" class="form-control" /></div>
    </div>
  </div>

  <!-- ğŸ”¹ æœå‹™é …ç›®ï¼ˆæ¡Œæ©Ÿï¼šè¡¨æ ¼ï¼›æ‰‹æ©Ÿï¼šå¡ç‰‡è¡¨å–®ï¼‰ -->
  <h5 class="section-title">æœå‹™é …ç›®</h5>
  <div class="table-responsive">
    <table id="quoteTable" class="table table-bordered bg-white">
      <thead class="table-light">
        <tr>
          <th>é …ç›®åç¨±</th>
          <th>è£œå……èªªæ˜</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>å°è¨ˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <!-- é è¨­ä¸€åˆ— -->
        <tr>
          <td>
            <select class="form-select service">
              <option value="">è«‹é¸æ“‡</option>
              <option value="å†·æ°£æ¸…æ´—">å†·æ°£æ¸…æ´—</option>
              <option value="æ´—è¡£æ©Ÿæ¸…æ´—">æ´—è¡£æ©Ÿæ¸…æ´—</option>
              <option value="é˜²éœ‰è™•ç†">é˜²éœ‰è™•ç†</option>
              <option value="è‡­æ°§æ®ºèŒ">è‡­æ°§æ®ºèŒ</option>
              <option value="è®Šå½¢é‡‘å‰›æ©Ÿå‹">è®Šå½¢é‡‘å‰›æ©Ÿå‹</option>
              <option value="ä¸€é«”å¼æ°´ç›¤æ©Ÿå‹">ä¸€é«”å¼æ°´ç›¤æ©Ÿå‹</option>
              <option value="è¶…é•·è²»ç”¨">è¶…é•·è²»ç”¨</option>
              <option value="è‡ªä¾†æ°´ç®¡æ¸…æ´—">è‡ªä¾†æ°´ç®¡æ¸…æ´—</option>
              <option value="æ°´å¡”æ¸…æ´—">æ°´å¡”æ¸…æ´—</option>
            </select>
          </td>
          <td>
            <select class="form-select option">
              <option value="">è«‹é¸æ“‡</option>
              <option>åˆ†é›¢å¼ï¼ˆå£æ›å¼ï¼‰</option>
              <option>åŠéš±å¼ï¼ˆéš±è—å¼ï¼‰</option>
              <option>ç›´ç«‹å¼</option>
              <option>å®¶ç”¨</option>
              <option>ç‰¹æ®Šæ©Ÿå‹é¡å¤–åŠ æ”¶è²»</option>
              <option>å†·æ°£é˜²éœ‰è™•ç†ï¼ˆæŠ‘èŒå™´åŠ‘ï¼‰</option>
              <option>é«˜è‡­æ°§æ®ºèŒ30åˆ†é˜</option>
              <option>åŠ è³¼åƒ¹</option>
              <option>ç„¡å»šä¸€è¡›</option>
              <option>ä¸€å»šä¸€è¡›</option>
              <option>ä¸€å»šå…©è¡›</option>
              <option>ä¸€å»šä¸‰è¡›</option>
              <option>ä¸€å»šå››è¡›</option>
            </select>
          </td>
          <td><input type="number" class="form-control qty" value="1" min="1" /></td>
          <td>
            <input type="number" class="form-control price" value="0" />
            <small class="discount-note"></small>
          </td>
          <td class="subtotal">0</td>
          <td><button class="btn btn-danger btn-sm removeRow">åˆªé™¤</button></td>
        </tr>
      </tbody>
    </table>
  </div>
  <button id="addRow" class="btn btn-primary mb-2">â• æ–°å¢é …ç›®</button>

  <!-- ğŸ”¹ å…¶ä»–äº‹é … -->
  <h5 class="section-title">å…¶ä»–äº‹é …</h5>
  <textarea id="otherNotes" class="form-control" rows="3">æœ€çµ‚è²»ç”¨å°‡ä¾ç¾å ´å¯¦éš›ç‹€æ³é€²è¡Œèª¿æ•´ï¼Œå¦‚æœ‰é¡å¤–é …ç›®ï¼Œå°‡äº‹å‰èˆ‡æ‚¨èªªæ˜èˆ‡å ±åƒ¹ã€‚</textarea>

  <!-- ğŸ”¹ åˆè¨ˆï¼ˆé†’ç›®æ¨£å¼ï¼‰ -->
  <h5 class="mt-3 total-banner">åˆè¨ˆï¼š<span id="total">0</span> å…ƒ</h5>

  <!-- ğŸ”¹ å‚™è¨»èˆ‡ä¿å›ºæ¢æ¬¾ -->
  <h5 class="section-title">å‚™è¨»èˆ‡ä¿å›ºæ¢æ¬¾</h5>
  <ol>
    <li>è«‹æ–¼ç¢ºèªæœ¬å ±åƒ¹å…§å®¹ç„¡èª¤å¾Œï¼Œä»¥è¨Šæ¯æ–¹å¼å›è¦†ï¼Œä»¥åˆ©å¾ŒçºŒå®‰æ’ä½œæ¥­ã€‚</li>
    <li>æ–½ä½œéç¨‹æ­¡è¿æ‚¨å…¨ç¨‹åœ¨å ´åƒèˆ‡ï¼Œç¢ºä¿æ–½å·¥éç¨‹é€æ˜ã€ä¿éšœé›™æ–¹æ¬Šç›Šã€‚</li>
    <li>æ–½ä½œå‰çš†æœƒé€²è¡ŒåŸºæœ¬åŠŸèƒ½æª¢æ¸¬ï¼Œç¢ºèªæ©Ÿæ³æ­£å¸¸å¾Œå†é€²è¡Œæ¸…æ´—ä¿é¤Šä½œæ¥­ã€‚</li>
    <li>æ–½ä½œå¦‚æœ‰æ‹æ”ç…§ç‰‡æˆ–å½±ç‰‡ï¼Œå¯å…è²»æä¾›çµ¦æ‚¨åšç‚ºç´€éŒ„èˆ‡å‚™å­˜åƒè€ƒã€‚</li>
    <li>æœ¬æœå‹™äº«æœ‰14å¤©ä¿å›ºæœŸï¼Œå¦‚æœ‰ç•°å¸¸ä½¿ç”¨ç‹€æ³ï¼Œè«‹ç«‹å³å›å ±ï¼Œæˆ‘å€‘å°‡å®‰æ’å°ˆäººè™•ç†ï¼ˆâ€»ä¿å›ºä¸åŒ…å«å› å®‰è£ä¸è‰¯æˆ–é›¶ä»¶è‡ªç„¶è€åŒ–æ‰€å°è‡´ä¹‹å•é¡Œï¼‰ã€‚</li>
    <li>è‹¥æ‚¨æœ‰ä»»ä½•ç–‘å•æˆ–éœ€é€²ä¸€æ­¥å”åŠ©ï¼Œæ­¡è¿ç›´æ¥è¯ç¹«æœå‹™çª—å£ï¼Œæˆ–æƒæå ±åƒ¹å–®å³ä¸‹è§’ä¹‹ LINE å®˜æ–¹å¸³è™Ÿ QR Codeï¼Œæˆ‘å€‘å°‡èª æ‘¯ç‚ºæ‚¨æœå‹™ã€‚</li>
  </ol>

  <!-- ğŸ”¹ è¯çµ¡è³‡è¨Š + ç¤¾ç¾¤ -->
  <h5 class="section-title">è¯çµ¡è³‡è¨Š</h5>
  <div class="row align-items-start">
    <div class="col-md-6 col-12 mb-2">
      <p><b>è‡ªç„¶å¤§å” / æ—å®¥é¨°</b><br/>
      é›»è©±ï¼š0912-356331<br/>
      Emailï¼šnatural.uncle@gmail.com</p>
    </div>
    <div class="col-md-6 col-12 text-center">
      <div class="d-grid gap-2">
        <a href="https://lin.ee/OHk6Rn7" target="_blank" class="btn btn-success">ğŸŸ¢ LINE å®˜æ–¹å¸³è™Ÿ</a>
        <a href="https://www.facebook.com/naturaluncle" target="_blank" class="btn btn-primary">ğŸ”µ Facebook ç²‰çµ²å°ˆé </a>
      </div>
    </div>
  </div>

  <!-- ğŸ”¹ åŠŸèƒ½æŒ‰éˆ•ï¼ˆä¾éœ€æ±‚ç§»é™¤ã€Œæˆ‘åŒæ„æ­¤å ±åƒ¹ã€ï¼›ä¿ç•™ã€Œç”¢ç”Ÿé€£çµã€ï¼‰ -->
  <div class="mt-3 text-center">
    <!-- <button id="confirmBtn" class="btn btn-outline-primary">âœ… æˆ‘åŒæ„æ­¤å ±åƒ¹</button>  å·²ç§»é™¤ -->
    <button id="shareLinkBtn" class="btn btn-secondary">ğŸ”— ç”¢ç”Ÿå ±åƒ¹å–®é€£çµ</button>
  </div>

  <!-- ğŸ”¹ ç”¢ç”Ÿé€£çµé¡¯ç¤º -->
  <div id="shareLinkBox" class="link-box d-none text-center"></div>

</div>

<!-- B. æ‰‹æ©Ÿåº•éƒ¨å›ºå®šå·¥å…·åˆ—ï¼ˆmd ä»¥ä¸‹é¡¯ç¤ºï¼›å”¯è®€æ™‚è‡ªå‹•éš±è—ã€Œç”¢ç”Ÿé€£çµã€ï¼‰ -->
<div class="mobile-bottom-bar d-md-none">
  <div class="total-strong">åˆè¨ˆï¼š<span id="totalMobile">0</span> å…ƒ</div>
  <div class="d-flex gap-2 flex-grow-1">
    <button class="btn btn-primary btn-sm flex-fill" id="confirmBtnMobile">æˆ‘åŒæ„æ­¤å ±åƒ¹</button>
    <button class="btn btn-outline-secondary btn-sm flex-fill" id="shareLinkBtnMobile">ç”¢ç”Ÿé€£çµ</button>
  </div>
</div>

<div class="footer-bar"><small>Â© 2025 è‡ªç„¶å¤§å” All Rights Reserved</small></div>

<script>
/* ===============================
   A. é ‚éƒ¨å›ºå®šè³‡è¨Šï¼šæ‰¿è¾¦é …ç›®ï¼‹å ±åƒ¹æ—¥æœŸ
   =============================== */
(function initHeader(){
  const project = "å®¶é›»æ¸…æ´—æœå‹™";
  const d = new Date();
  const dateStr = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
  document.getElementById("quoteInfo").textContent = `æ‰¿è¾¦é …ç›®ï¼š${project} ï½œ å ±åƒ¹æ—¥æœŸï¼š${dateStr}`;
})();

/* ===============================
   B. é ç´„æ™‚é–“ï¼šåœ¨è—è‰²å€å¡Šå³æ™‚åˆæˆå¯è®€å­—ä¸²
   =============================== */
function updateCleanFull(){
  const dv = document.getElementById("cleanDate").value;
  const tv = document.getElementById("cleanTime").value;
  if(!dv || !tv) return;
  const dt = new Date(`${dv}T${tv}`);
  const wd = ["æ˜ŸæœŸæ—¥","æ˜ŸæœŸä¸€","æ˜ŸæœŸäºŒ","æ˜ŸæœŸä¸‰","æ˜ŸæœŸå››","æ˜ŸæœŸäº”","æ˜ŸæœŸå…­"][dt.getDay()];
  const yyyy = dt.getFullYear(), mm = String(dt.getMonth()+1).padStart(2,'0'), dd = String(dt.getDate()).padStart(2,'0');
  const hh = String(dt.getHours()).padStart(2,'0'), mi = String(dt.getMinutes()).padStart(2,'0');
  const ampm = dt.getHours() < 12 ? "ä¸Šåˆ" : "ä¸‹åˆ";
  document.getElementById("cleanFull").textContent = `${yyyy}/${mm}/${dd}ï¼ˆ${wd}ï¼‰${ampm} ${hh}:${mi} é–‹å§‹`;
}
document.getElementById("cleanDate").addEventListener("change", updateCleanFull);
document.getElementById("cleanTime").addEventListener("change", updateCleanFull);

/* ===============================
   C. è‡ªå‹•å¸¶åƒ¹ + å„ªæƒ è¦å‰‡ + æ‰‹å‹•è¦†å¯«
   =============================== */
function updateTotals(){
  let total = 0;

  // å…ˆæƒä¸€è¼ªï¼Œåˆ¤æ–·å…¨è¡¨æ˜¯å¦ã€Œå­˜åœ¨å†·æ°£æ¸…æ´—ã€èˆ‡ã€Œå­˜åœ¨è‡ªä¾†æ°´ç®¡æ¸…æ´—ã€
  let hasAC = false, hasPipe = false;
  document.querySelectorAll("#quoteTable tbody tr").forEach(tr=>{
    const s = tr.querySelector(".service")?.value || "";
    if(s === "å†·æ°£æ¸…æ´—") hasAC = true;
    if(s === "è‡ªä¾†æ°´ç®¡æ¸…æ´—") hasPipe = true;
  });

  // é€åˆ—è¨ˆç®—
  document.querySelectorAll("#quoteTable tbody tr").forEach(tr=>{
    const service = tr.querySelector(".service")?.value || "";
    const option  = tr.querySelector(".option")?.value  || "";
    const qtyEl   = tr.querySelector(".qty");
    const priceEl = tr.querySelector(".price");
    const noteEl  = tr.querySelector(".discount-note");
    const subEl   = tr.querySelector(".subtotal");

    const qty = Math.max(1, Number(qtyEl?.value || 1));
    let price = Number(priceEl?.value || 0);

    if(noteEl) noteEl.textContent = "";

    const overridden = priceEl?.dataset.override === "true";
    if(!overridden){
      if(service === "å†·æ°£æ¸…æ´—" && option.includes("åˆ†é›¢å¼")){
        price = (qty >= 3) ? 1500 : 1800;
        if(qty >= 3 && noteEl) noteEl.textContent = "å·²å¥—ç”¨ä¸‰å°ä»¥ä¸Šå„ªæƒ åƒ¹";
      } else if(service === "å†·æ°£æ¸…æ´—" && option.includes("åŠéš±å¼")){
        price = 2800;
      } else if(service === "æ´—è¡£æ©Ÿæ¸…æ´—" && option.includes("ç›´ç«‹å¼")){
        price = hasAC ? 1800 : 2000;
        if(hasAC && noteEl) noteEl.textContent = "å·²å¥—ç”¨å†·æ°£æ¸…æ´—å„ªæƒ åƒ¹";
      } else if(service === "é˜²éœ‰è™•ç†"){
        price = (qty >= 5) ? 250 : 300;
        if(qty >= 5 && noteEl) noteEl.textContent = "å·²å¥—ç”¨äº”å°ä»¥ä¸Šå„ªæƒ åƒ¹";
      } else if(service === "è‡­æ°§æ®ºèŒ"){
        price = (qty >= 5) ? 150 : 200;
        if(qty >= 5 && noteEl) noteEl.textContent = "å·²å¥—ç”¨äº”å°ä»¥ä¸Šå„ªæƒ åƒ¹";
      } else if(service === "è®Šå½¢é‡‘å‰›æ©Ÿå‹"){
        price = 500;
      } else if(service === "ä¸€é«”å¼æ°´ç›¤æ©Ÿå‹"){
        price = 500;
      } else if(service === "è¶…é•·è²»ç”¨"){
        price = 300;
      } else if(service === "æ°´å¡”æ¸…æ´—"){
        price = hasPipe ? 800 : 1000;
        if(hasPipe && noteEl) noteEl.textContent = "å·²å¥—ç”¨è‡ªä¾†æ°´ç®¡æ¸…æ´—å„ªæƒ åƒ¹";
      }
      if(priceEl) priceEl.value = price; // åŒæ­¥åˆ°ç•«é¢
    }

    const subtotal = qty * (Number(priceEl?.value || price) || 0);
    if(subEl) subEl.textContent = String(subtotal);
    total += subtotal;
  });

  document.getElementById("total").textContent = String(total);
  const tm = document.getElementById("totalMobile");
  if (tm) tm.textContent = String(total);
}

// æ‰‹æ©Ÿå¡ç‰‡åŒ–ï¼šç‚ºæ¯å€‹ td åŠ ä¸Š data-labelï¼Œä¾› ::before ä½¿ç”¨
function applyMobileLabels(){
  const labels = Array.from(document.querySelectorAll('#quoteTable thead th'))
    .map(th => th.textContent.trim());
  document.querySelectorAll('#quoteTable tbody tr').forEach(tr=>{
    Array.from(tr.children).forEach((td, i)=>{
      td.setAttribute('data-label', labels[i] || '');
    });
  });
}

// äº‹ä»¶å§”æ´¾ï¼šæ”¹æœå‹™/è£œå……/æ•¸é‡ â†’ è§£é™¤è¦†å¯«ã€é‡ç®—
document.querySelector("#quoteTable tbody").addEventListener("change", (e)=>{
  if(e.target.classList.contains("service") || e.target.classList.contains("option") || e.target.classList.contains("qty")){
    const rowPrice = e.target.closest("tr").querySelector(".price");
    if(rowPrice && rowPrice.dataset.override) delete rowPrice.dataset.override;
    updateTotals();
  }
});

// æ‰‹å‹•è¼¸å…¥å–®åƒ¹ â†’ è¨­è¦†å¯«æ——æ¨™ï¼Œä¸¦é‡ç®—
document.querySelector("#quoteTable tbody").addEventListener("input", (e)=>{
  if(e.target.classList.contains("price")){
    e.target.dataset.override = "true";
    updateTotals();
  } else if(e.target.classList.contains("qty")){
    updateTotals();
  }
});

// æ–°å¢/åˆªé™¤åˆ—
document.getElementById("addRow").addEventListener("click", ()=>{
  const tbody = document.querySelector("#quoteTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select class="form-select service">
        <option value="">è«‹é¸æ“‡</option>
        <option value="å†·æ°£æ¸…æ´—">å†·æ°£æ¸…æ´—</option>
        <option value="æ´—è¡£æ©Ÿæ¸…æ´—">æ´—è¡£æ©Ÿæ¸…æ´—</option>
        <option value="é˜²éœ‰è™•ç†">é˜²éœ‰è™•ç†</option>
        <option value="è‡­æ°§æ®ºèŒ">è‡­æ°§æ®ºèŒ</option>
        <option value="è®Šå½¢é‡‘å‰›æ©Ÿå‹">è®Šå½¢é‡‘å‰›æ©Ÿå‹</option>
        <option value="ä¸€é«”å¼æ°´ç›¤æ©Ÿå‹">ä¸€é«”å¼æ°´ç›¤æ©Ÿå‹</option>
        <option value="è¶…é•·è²»ç”¨">è¶…é•·è²»ç”¨</option>
        <option value="è‡ªä¾†æ°´ç®¡æ¸…æ´—">è‡ªä¾†æ°´ç®¡æ¸…æ´—</option>
        <option value="æ°´å¡”æ¸…æ´—">æ°´å¡”æ¸…æ´—</option>
      </select>
    </td>
    <td>
      <select class="form-select option">
        <option value="">è«‹é¸æ“‡</option>
        <option>åˆ†é›¢å¼ï¼ˆå£æ›å¼ï¼‰</option>
        <option>åŠéš±å¼ï¼ˆéš±è—å¼ï¼‰</option>
        <option>ç›´ç«‹å¼</option>
        <option>å®¶ç”¨</option>
        <option>ç‰¹æ®Šæ©Ÿå‹é¡å¤–åŠ æ”¶è²»</option>
        <option>å†·æ°£é˜²éœ‰è™•ç†ï¼ˆæŠ‘èŒå™´åŠ‘ï¼‰</option>
        <option>é«˜è‡­æ°§æ®ºèŒ30åˆ†é˜</option>
        <option>åŠ è³¼åƒ¹</option>
        <option>ç„¡å»šä¸€è¡›</option>
        <option>ä¸€å»šä¸€è¡›</option>
        <option>ä¸€å»šå…©è¡›</option>
        <option>ä¸€å»šä¸‰è¡›</option>
        <option>ä¸€å»šå››è¡›</option>
      </select>
    </td>
    <td><input type="number" class="form-control qty" value="1" min="1" /></td>
    <td><input type="number" class="form-control price" value="0" /><small class="discount-note"></small></td>
    <td class="subtotal">0</td>
    <td><button class="btn btn-danger btn-sm removeRow">åˆªé™¤</button></td>
  `;
  tbody.appendChild(tr);
  updateTotals();
  applyMobileLabels();
});
document.querySelector("#quoteTable tbody").addEventListener("click",(e)=>{
  if(e.target.classList.contains("removeRow")){
    e.target.closest("tr").remove();
    updateTotals();
    applyMobileLabels();
  }
});

/* ===============================
   D. ã€Œæˆ‘åŒæ„æ­¤å ±åƒ¹ã€æäº¤ï¼ˆè¡Œå‹•ç‰ˆå¿«æ·éµå¯ç”¨ï¼›æ¡Œæ©Ÿå·²ç§»é™¤æŒ‰éˆ•ï¼‰
   =============================== */
async function handleConfirmSubmit(clickedBtn){
  // clickedBtn å¯èƒ½æ˜¯æ‰‹æ©Ÿåº•æ¬„çš„æŒ‰éˆ•
  if (clickedBtn && clickedBtn.disabled) return;
  const originalText = clickedBtn ? clickedBtn.textContent : "";

  try{
    if (clickedBtn){
      clickedBtn.disabled = true;
      clickedBtn.textContent = "é€å‡ºä¸­â€¦";
    }

    const payload = collectShareData();
    const hash = location.hash || "";
    if (hash.startsWith("#cid=")) {
      payload.cloudinaryId = decodeURIComponent(hash.replace("#cid=",""));
    }

    const res = await fetch("/api/confirm", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const t = await res.text();
      alert("é€å‡ºå¤±æ•—ï¼š" + t);
      if (clickedBtn){
        clickedBtn.disabled = false;
        clickedBtn.textContent = originalText;
      }
      return;
    }

    await res.json();
    alert("âœ… å·²é€å‡ºåŒæ„ï¼æ„Ÿè¬æ‚¨çš„å¯Ÿçœ‹ï¼Œæ­¤å°‡ç•™å­˜ç´€éŒ„");
    if (clickedBtn){
      clickedBtn.textContent = "å·²é€å‡ºåŒæ„";
      clickedBtn.disabled = true; // ä¿æŒé–ä½
    }
  }catch(err){
    console.error(err);
    alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    if (clickedBtn){
      clickedBtn.disabled = false;
      clickedBtn.textContent = originalText;
    }
  }
}

// ç¶å®šæ‰‹æ©Ÿåº•æ¬„ã€Œæˆ‘åŒæ„æ­¤å ±åƒ¹ã€
document.getElementById('confirmBtnMobile')?.addEventListener('click', function(){
  handleConfirmSubmit(this);
});

/* ===============================
   E. ç”¢ç”Ÿåˆ†äº«é€£çµ
   - ç·¨è¼¯æ¨¡å¼ï¼šå¯ç”¨ï¼ˆæ¡Œæ©Ÿåº•éƒ¨æŒ‰éˆ•ï¼‹æ‰‹æ©Ÿå¿«æ·ï¼‰
   - å”¯è®€æ¨¡å¼ï¼šéš±è—ï¼ˆåŒ…å«æ‰‹æ©Ÿå¿«æ·ï¼‰
   =============================== */
async function handleShareClick(){
  try{
    const payload = collectShareData();
    const res = await fetch("/api/share", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const t = await res.text();
      alert("ç”¢ç”Ÿé€£çµå¤±æ•—ï¼š" + t);
      return;
    }

    const data = await res.json();
    const href = data.share_url || data.pdf_url || "#";
    const box = document.getElementById("shareLinkBox");
    box.classList.remove("d-none");
    box.innerHTML = `<b>å°ˆå±¬å ±åƒ¹å–®ç¶²å€ï¼š</b><br><a href="${href}" target="_blank">${href}</a>`;
    window._lastShare = data;
  }catch(err){
    console.error(err);
    alert("ç”¢ç”Ÿé€£çµå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
  }
}

document.getElementById("shareLinkBtn")?.addEventListener("click", handleShareClick);
document.getElementById('shareLinkBtnMobile')?.addEventListener('click', handleShareClick);

/* ===============================
   å…±ç”¨ï¼šåºåˆ—åŒ–ç›®å‰ç•«é¢è³‡æ–™
   =============================== */
function collectShareData(){
  const items = [];
  document.querySelectorAll("#quoteTable tbody tr").forEach(tr=>{
    items.push({
      service: tr.querySelector(".service")?.value || "",
      option:  tr.querySelector(".option")?.value  || "",
      qty:     tr.querySelector(".qty")?.value     || "1",
      price:   tr.querySelector(".price")?.value   || "0",
      subtotal:tr.querySelector(".subtotal")?.textContent || "0",
      overridden: tr.querySelector(".price")?.dataset.override === "true"
    });
  });
  return {
    quoteInfo: document.getElementById("quoteInfo").textContent,
    customer:  document.getElementById("customerName").value,
    phone:     document.getElementById("customerPhone").value,
    address:   document.getElementById("customerAddress").value,
    technician:document.getElementById("technicianName").value,
    techPhone: document.getElementById("technicianPhone").value,
    cleanTime: document.getElementById("cleanFull").textContent,
    otherNotes:document.getElementById("otherNotes").value,
    items,
    total: document.getElementById("total").textContent
  };
}

/* ===============================
   F. å”¯è®€æ¨¡å¼è¼‰å…¥
   - æ”¯æ´ #cid=... ï¼ˆèµ° /api/view è®€ Cloudinaryï¼‰
   - å…¼å®¹èˆŠçš„ #data=... ç›´æ¥é‚„åŸ
   - å”¯è®€æ™‚ï¼šéš±è—ã€Œæ–°å¢é …ç›®ã€ã€Œç”¢ç”Ÿé€£çµï¼ˆæ¡Œæ©Ÿï¼‹æ‰‹æ©Ÿï¼‰ã€
   =============================== */
(async function loadReadOnlyIfHash(){
  const hash = location.hash || "";

  // A) æ–°æ–¹å¼ï¼š#cid=çŸ­ä»£ç¢¼
  if (hash.startsWith("#cid=")) {
    try{
      const cid = decodeURIComponent(hash.replace("#cid=",""));
      const r = await fetch(`/api/view?id=${encodeURIComponent(cid)}`);
      if(!r.ok) throw new Error(await r.text());
      const data = await r.json();
      applyReadOnlyData(data);
      applyMobileLabels();
      return;
    }catch(e){
      console.error("è®€å–åˆ†äº«è³‡æ–™å¤±æ•—ï¼š", e);
      alert("è®€å–åˆ†äº«è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªé€£çµæ˜¯å¦æ­£ç¢ºã€‚");
      updateTotals();
      applyMobileLabels();
      return;
    }
  }

  // B) èˆŠæ–¹å¼ï¼š#data=...
  if (hash.startsWith("#data=")) {
    try{
      const data = JSON.parse(decodeURIComponent(hash.replace("#data=","")));
      applyReadOnlyData(data);
      applyMobileLabels();
      return;
    }catch(err){
      console.error("è®€å–åˆ†äº«è³‡æ–™å¤±æ•—ï¼š", err);
      updateTotals();
      applyMobileLabels();
      return;
    }
  }

  // C) ç„¡ hash â†’ ç·¨è¼¯æ¨¡å¼
  updateTotals();
  applyMobileLabels();
})();

function applyReadOnlyData(data){
  // é ‚éƒ¨è³‡è¨Š
  if(data.quoteInfo) document.getElementById("quoteInfo").textContent = data.quoteInfo;
  // åŸºæœ¬æ¬„ä½
  document.getElementById("customerName").value   = data.customer  || "";
  document.getElementById("customerPhone").value  = data.phone     || "";
  document.getElementById("customerAddress").value= data.address   || "";
  document.getElementById("technicianName").value = data.technician|| "";
  document.getElementById("technicianPhone").value= data.techPhone || "";
  document.getElementById("cleanFull").textContent= data.cleanTime || "å°šæœªé¸æ“‡";
  document.getElementById("otherNotes").value     = data.otherNotes|| "";

  // é‡å»ºè¡¨æ ¼
  const tbody = document.querySelector("#quoteTable tbody");
  tbody.innerHTML = "";
  (data.items || []).forEach(it=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><select class="form-select service" disabled><option>${it.service||""}</option></select></td>
      <td><select class="form-select option" disabled><option>${it.option||""}</option></select></td>
      <td><input type="number" class="form-control qty" value="${it.qty||1}" readonly /></td>
      <td><input type="number" class="form-control price" value="${it.price||0}" readonly /><small class="discount-note"></small></td>
      <td class="subtotal">${it.subtotal||0}</td>
      <td></td>
    `;
    tbody.appendChild(tr);
  });

  // é–å®šå”¯è®€
  document.querySelectorAll("input, textarea").forEach(el=>el.setAttribute("readonly", true));
  document.querySelectorAll("select").forEach(el=>el.setAttribute("disabled", true));

  // å”¯è®€ï¼šéš±è—ã€Œæ–°å¢é …ç›®ã€èˆ‡ã€Œç”¢ç”Ÿé€£çµã€ï¼ˆæ¡Œæ©Ÿï¼‹æ‰‹æ©Ÿï¼‰
  document.getElementById("addRow").style.display = "none";
  const shareBtn = document.getElementById("shareLinkBtn");
  if (shareBtn) shareBtn.style.display = "none";
  const shareBtnMobile = document.getElementById("shareLinkBtnMobile");
  if (shareBtnMobile) shareBtnMobile.style.display = "none";

  updateTotals();
}
</script>
</body>
</html>
